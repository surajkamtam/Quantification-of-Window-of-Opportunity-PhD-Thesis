import xml.etree.ElementTree as ET
import subprocess
import shutil
import os

def get_depart_value(rou_xml_file):
    tree = ET.parse(rou_xml_file)
    root = tree.getroot()

    vehicle = root.find('.//vehicle')
    if vehicle is not None:
        return int(vehicle.get('depart'))
    else:
        raise ValueError("No vehicle definition found in the XML file.")

def change_depart_value(rou_xml_file, new_depart_value, new_vehs_per_hour_veh, new_vehs_per_hour_i0):
    tree = ET.parse(rou_xml_file)
    root = tree.getroot()

    # Update vehsPerHour for veh0 and veh1
    for flow in root.findall('.//flow'):
        if flow.get('id') in ["veh0", "veh1"]:
            flow.set('vehsPerHour', str(new_vehs_per_hour_veh))

    # Update vehsPerHour for flow i0
    for flow in root.findall('.//flow[@id="i0"]'):
        flow.set('vehsPerHour', str(new_vehs_per_hour_i0))

    # Update the depart time for vehicle with id="v0"
    for vehicle in root.findall('.//vehicle[@id="v0"]'):
        vehicle.set('depart', str(new_depart_value))

    tree.write(rou_xml_file)

def change_seed_value(launchd_xml_file, new_seed_value):
    tree = ET.parse(launchd_xml_file)
    root = tree.getroot()

    for seed_element in root.iter('seed'):
        seed_element.set('value', str(new_seed_value))

    tree.write(launchd_xml_file)

def execute_simulation(command):
    subprocess.run(command, shell=True)

if __name__ == "__main__":
    base_folder = "/home/suraj/Downloads/Simulation/losTest1"
    rou_xml_file_path = os.path.join(base_folder, "lostest1.rou.xml")
    launchd_xml_file_path = os.path.join(base_folder, "lostest1.launchd.xml")
    output_base_folder = "/home/suraj/Downloads/output_files20NovPassiveAttackP11"
    initial_depart_value = 885
    final_depart_value = 890
    simulation_runs = 50

    # Pair vehs_per_hour values with separate veh0/veh1 and i0 values
    vehs_per_hour_combinations = {
        450: 100,
        720: 160,
        810: 180,
        990: 220,
        1170: 260
    }

    os.makedirs(output_base_folder, exist_ok=True)

    base_command = "opp_run -r 0 -m -u Cmdenv -n .:../veins-5.2/examples/veins:../veins-5.2/src/veins --image-path=../veins-5.2/images -l ../veins-5.2/src/veins omnetpp.ini"

    # Iterate over the vehs_per_hour combinations
    for vehs_per_hour_veh, vehs_per_hour_i0 in vehs_per_hour_combinations.items():
        vehs_output_folder = os.path.join(output_base_folder, f"vehsPerHour_{vehs_per_hour_veh}")
        os.makedirs(vehs_output_folder, exist_ok=True)

        for depart_value in range(initial_depart_value, final_depart_value):  # Loop through depart values 900 to 915
            depart_output_folder = os.path.join(vehs_output_folder, f"depart_{depart_value}")
            os.makedirs(depart_output_folder, exist_ok=True)

            for i in range(1, simulation_runs + 1):  # Run simulation 50 times for each depart value
                seed_value = i

                # Change depart value for vehicle id="v0" and vehsPerHour for flows
                change_depart_value(rou_xml_file_path, depart_value, vehs_per_hour_veh, vehs_per_hour_i0)

                # Change seed value in the launchd.xml file
                change_seed_value(launchd_xml_file_path, seed_value)

                # Run simulation
                execute_simulation(base_command)

                # Copy output files directly to depart output folder
                for file_name in ["out.txt", "rt.txt", "test.txt", "detector_output.xml"]:
                    src_file = os.path.join(base_folder, file_name)
                    dest_file = os.path.join(depart_output_folder, f"{file_name.split('.')[0]}_{i}.txt")
                    shutil.copy(src_file, dest_file)

